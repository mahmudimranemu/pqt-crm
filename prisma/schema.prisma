// PQT CRM Database Schema
// Property Quest Turkey - Customer Relationship Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================
// ENUMS
// =====================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  SALES_MANAGER
  SALES_AGENT
  VIEWER
}

enum Office {
  UAE
  TURKEY
  UK
  MALAYSIA
  BANGLADESH
  HEAD_OFFICE
}

enum PropertyType {
  APARTMENT
  VILLA
  COMMERCIAL
  LAND
  PENTHOUSE
}

enum InvestmentPurpose {
  CITIZENSHIP
  INVESTMENT
  RESIDENTIAL
  COMMERCIAL
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  GOOGLE_ADS
  FACEBOOK_ADS
  WALK_IN
  PARTNER
  OTHER
}

enum ClientStatus {
  NEW_LEAD
  CONTACTED
  QUALIFIED
  VIEWING_SCHEDULED
  VIEWED
  NEGOTIATING
  DEAL_CLOSED
  LOST
  INACTIVE
}

enum District {
  BEYLIKDUZU
  BASAKSEHIR
  ESENYURT
  KUCUKCEKMECE
  BAHCESEHIR
  BAKIRKOY
  SISLI
  BESIKTAS
  KADIKOY
  USKUDAR
  MALTEPE
  KARTAL
  PENDIK
  TUZLA
  AVCILAR
  BEYOGLU
  FATIH
  SARIYER
  BEYKOZ
  ZEYTINBURNU
}

enum PropertyStatus {
  ACTIVE
  SOLD_OUT
  COMING_SOON
  OFF_MARKET
}

enum EnquirySource {
  WEBSITE_FORM
  PHONE_CALL
  EMAIL
  WHATSAPP
  LIVE_CHAT
  PARTNER_REFERRAL
}

enum EnquiryStatus {
  NEW
  ASSIGNED
  CONTACTED
  CONVERTED_TO_CLIENT
  SPAM
  CLOSED
}

enum BookingType {
  PROPERTY_VIEWING
  FOLLOW_UP_MEETING
  DOCUMENT_SIGNING
  TITLE_DEED
}

enum BookingStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  NO_SHOW
  CANCELLED
  RESCHEDULED
}

enum BookingOutcome {
  PENDING
  INTERESTED
  NOT_INTERESTED
  OFFER_MADE
  SOLD
}

enum Currency {
  USD
  EUR
  GBP
  TRY
  AED
}

enum SaleStatus {
  PENDING_DEPOSIT
  DEPOSIT_RECEIVED
  CONTRACT_SIGNED
  TITLE_DEED_TRANSFER
  COMPLETED
  CANCELLED
}

enum CitizenshipStage {
  DOCUMENT_COLLECTION
  PROPERTY_VALUATION
  APPLICATION_FILED
  BIOMETRICS_SCHEDULED
  BIOMETRICS_COMPLETED
  UNDER_REVIEW
  INTERVIEW_SCHEDULED
  INTERVIEW_COMPLETED
  APPROVED
  PASSPORT_ISSUED
  REJECTED
}

enum ApplicantType {
  MAIN_APPLICANT
  SPOUSE
  DEPENDENT_CHILD
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  SKIPPED
}

enum Relationship {
  SPOUSE
  CHILD
}

enum FamilyMemberStatus {
  INCLUDED
  EXCLUDED
  APPROVED
  REJECTED
}

enum DocumentCategory {
  PASSPORT
  TITLE_DEED
  POWER_OF_ATTORNEY
  CITIZENSHIP_APPLICATION
  CONTRACT
  BANK_STATEMENT
  PHOTO
  BIRTH_CERTIFICATE
  MARRIAGE_CERTIFICATE
  OTHER
}

enum CallType {
  OUTBOUND
  INBOUND
}

enum CallOutcome {
  CONNECTED
  VOICEMAIL
  NO_ANSWER
  BUSY
  WRONG_NUMBER
}

enum CommunicationType {
  EMAIL
  PHONE
  WHATSAPP
  SMS
  IN_PERSON
  NOTE
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

// =====================
// MODELS
// =====================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(SALES_AGENT)
  office    Office
  isActive            Boolean   @default(true)
  phone               String?
  avatar              String?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  twoFactorEnabled    Boolean   @default(false)
  twoFactorSecret     String?
  emailVerifyToken    String?
  emailVerifyNewEmail String?
  emailVerifyExpires  DateTime?
  passwordResetToken  String?
  passwordResetExpires DateTime?
  lastSeen            DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  clients        Client[]
  bookings       Booking[]
  sales          Sale[]
  callLogs       CallLog[]
  timeEntries    TimeEntry[]
  loginLogs      LoginLog[]
  communications Communication[]
  documents      Document[]
  enquiries      Enquiry[]
  enquiryNotes   EnquiryNote[]

  // New CRM relations
  ownedLeads       Lead[]       @relation("LeadOwner")
  leadNotes        LeadNote[]   @relation("LeadNoteAgent")
  ownedDeals       Deal[]       @relation("DealOwner")
  assignedTasks    Task[]       @relation("TaskAssignee")
  createdTasks     Task[]       @relation("TaskCreator")
  commissions      Commission[]
  auditLogs        AuditLog[]
  managedTeams     Team[]       @relation("TeamManager")
  teamMemberships  TeamMember[]
  notifications    Notification[]
  activities       Activity[]
  handovers        Handover[]     @relation("HandoverAssignee")

  @@map("users")
}

model Client {
  id                    String            @id @default(cuid())
  firstName             String
  lastName              String
  email                 String
  phone                 String
  whatsapp              String?
  nationality           String
  country               String
  city                  String?
  passportNumber        String?
  dateOfBirth           DateTime?
  budgetMin             Decimal           @db.Decimal(15, 2)
  budgetMax             Decimal           @db.Decimal(15, 2)
  preferredDistricts    District[]
  preferredPropertyType PropertyType?
  investmentPurpose     InvestmentPurpose @default(RESIDENTIAL)
  source                LeadSource        @default(WEBSITE)
  status                ClientStatus      @default(NEW_LEAD)
  notes                 String?           @db.Text
  tags                  String[]          @default([])
  assignedAgentId       String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  assignedAgent            User?                     @relation(fields: [assignedAgentId], references: [id])
  bookings                 Booking[]
  enquiries                Enquiry[]
  documents                Document[]
  communications           Communication[]
  citizenshipApplications  CitizenshipApplication[]
  sales                    Sale[]

  // New CRM relations
  leads      Lead[]
  deals      Deal[]
  payments   Payment[]
  activities Activity[]
  handovers  Handover[]

  @@index([assignedAgentId])
  @@index([status])
  @@index([email])
  @@map("clients")
}

model Property {
  id                  String         @id @default(cuid())
  pqtNumber           String         @unique
  name                String
  developer           String?
  district            District
  address             String?
  propertyType        PropertyType
  totalUnits          Int?
  availableUnits      Int?
  priceFrom           Decimal        @db.Decimal(15, 2)
  priceTo             Decimal        @db.Decimal(15, 2)
  sizeFrom            Decimal?       @db.Decimal(10, 2)
  sizeTo              Decimal?       @db.Decimal(10, 2)
  bedrooms            String?
  amenities           String[]
  completionDate      DateTime?
  status              PropertyStatus @default(ACTIVE)
  citizenshipEligible Boolean        @default(false)
  description         String?        @db.Text
  images              String[]
  floorPlans          String[]
  latitude            Decimal?       @db.Decimal(10, 8)
  longitude           Decimal?       @db.Decimal(11, 8)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  // Relations
  bookings  Booking[]
  sales     Sale[]
  enquiries Enquiry[]
  interestedLeads Lead[] @relation("LeadProperty")

  @@index([district])
  @@index([status])
  @@map("properties")
}

model Enquiry {
  id                String        @id @default(cuid())
  firstName         String
  lastName          String
  email             String
  phone             String
  message           String?       @db.Text
  source            EnquirySource @default(WEBSITE_FORM)
  sourceUrl         String?
  status            EnquiryStatus @default(NEW)
  assignedAgentId   String?
  convertedClientId String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Extended fields
  budget            String?
  country           String?
  tags              String[]      @default([])
  called            Boolean       @default(false)
  spoken            Boolean       @default(false)
  segment           String?       @default("Buyer")
  leadStatus        String?       @default("New")
  priority          String?       @default("Medium")
  nextCallDate      DateTime?
  snooze              String?       @default("Active")
  interestedPropertyId String?

  // Relations
  assignedAgent      User?          @relation(fields: [assignedAgentId], references: [id])
  convertedClient    Client?        @relation(fields: [convertedClientId], references: [id])
  interestedProperty Property?      @relation(fields: [interestedPropertyId], references: [id])
  notes              EnquiryNote[]
  activities         Activity[]

  @@index([status])
  @@index([assignedAgentId])
  @@map("enquiries")
}

model EnquiryNote {
  id        String   @id @default(cuid())
  enquiryId String
  agentId   String
  content   String   @db.Text
  createdAt DateTime @default(now())

  // Relations
  enquiry Enquiry @relation(fields: [enquiryId], references: [id], onDelete: Cascade)
  agent   User    @relation(fields: [agentId], references: [id])

  @@index([enquiryId])
  @@index([createdAt])
  @@map("enquiry_notes")
}

model Booking {
  id           String          @id @default(cuid())
  clientId     String
  propertyId   String
  agentId      String
  bookingDate  DateTime
  bookingType  BookingType     @default(PROPERTY_VIEWING)
  status       BookingStatus   @default(SCHEDULED)
  outcome      BookingOutcome?
  notes        String?         @db.Text
  noSaleReason String?         @db.Text
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  client   Client   @relation(fields: [clientId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])
  agent    User     @relation(fields: [agentId], references: [id])
  sale     Sale?

  @@index([clientId])
  @@index([propertyId])
  @@index([agentId])
  @@index([bookingDate])
  @@index([status])
  @@map("bookings")
}

model Sale {
  id                  String     @id @default(cuid())
  bookingId           String?    @unique
  clientId            String
  propertyId          String
  agentId             String
  unitNumber          String?
  salePrice           Decimal    @db.Decimal(15, 2)
  currency            Currency   @default(USD)
  paymentPlan         String?    @db.Text
  depositAmount       Decimal?   @db.Decimal(15, 2)
  depositDate         DateTime?
  completionDate      DateTime?
  commissionAmount    Decimal?   @db.Decimal(15, 2)
  status              SaleStatus @default(PENDING_DEPOSIT)
  citizenshipEligible Boolean    @default(false)
  notes               String?    @db.Text
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  booking                Booking?                @relation(fields: [bookingId], references: [id])
  client                 Client                  @relation(fields: [clientId], references: [id])
  property               Property                @relation(fields: [propertyId], references: [id])
  agent                  User                    @relation(fields: [agentId], references: [id])
  citizenshipApplication CitizenshipApplication?

  @@index([clientId])
  @@index([propertyId])
  @@index([agentId])
  @@index([status])
  @@map("sales")
}

model CitizenshipApplication {
  id                      String           @id @default(cuid())
  saleId                  String           @unique
  clientId                String
  applicationNumber       String?
  stage                   CitizenshipStage @default(DOCUMENT_COLLECTION)
  applicantType           ApplicantType    @default(MAIN_APPLICANT)
  startDate               DateTime         @default(now())
  estimatedCompletionDate DateTime?
  actualCompletionDate    DateTime?
  notes                   String?          @db.Text
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  // Relations
  sale          Sale                   @relation(fields: [saleId], references: [id])
  client        Client                 @relation(fields: [clientId], references: [id])
  milestones    CitizenshipMilestone[]
  familyMembers FamilyMember[]
  documents     Document[]

  @@index([clientId])
  @@index([stage])
  @@map("citizenship_applications")
}

model CitizenshipMilestone {
  id            String          @id @default(cuid())
  applicationId String
  milestone     String
  dueDate       DateTime?
  completedDate DateTime?
  status        MilestoneStatus @default(PENDING)
  notes         String?         @db.Text
  createdAt     DateTime        @default(now())

  // Relations
  application CitizenshipApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([status])
  @@map("citizenship_milestones")
}

model FamilyMember {
  id             String             @id @default(cuid())
  applicationId  String
  firstName      String
  lastName       String
  relationship   Relationship
  dateOfBirth    DateTime?
  passportNumber String?
  status         FamilyMemberStatus @default(INCLUDED)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relations
  application CitizenshipApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@map("family_members")
}

model Document {
  id            String           @id @default(cuid())
  name          String
  fileUrl       String
  fileType      String
  category      DocumentCategory @default(OTHER)
  clientId      String?
  applicationId String?
  uploadedById  String
  createdAt     DateTime         @default(now())

  // Relations
  client      Client?                 @relation(fields: [clientId], references: [id])
  application CitizenshipApplication? @relation(fields: [applicationId], references: [id])
  uploadedBy  User                    @relation(fields: [uploadedById], references: [id])

  @@index([clientId])
  @@index([applicationId])
  @@map("documents")
}

model CallLog {
  id       String      @id @default(cuid())
  agentId  String
  clientId String?
  callType CallType    @default(OUTBOUND)
  duration Int         @default(0)
  outcome  CallOutcome @default(NO_ANSWER)
  notes    String?     @db.Text
  callDate DateTime    @default(now())

  // Relations
  agent User @relation(fields: [agentId], references: [id])

  @@index([agentId])
  @@index([callDate])
  @@map("call_logs")
}

model TimeEntry {
  id          String   @id @default(cuid())
  agentId     String
  date        DateTime
  hoursWorked Decimal  @db.Decimal(4, 2)
  description String?  @db.Text
  createdAt   DateTime @default(now())

  // Relations
  agent User @relation(fields: [agentId], references: [id])

  @@index([agentId])
  @@index([date])
  @@map("time_entries")
}

model LoginLog {
  id         String    @id @default(cuid())
  userId     String
  loginTime  DateTime  @default(now())
  logoutTime DateTime?
  ipAddress  String?

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([loginTime])
  @@map("login_logs")
}

model Communication {
  id        String                 @id @default(cuid())
  clientId  String
  agentId   String
  type      CommunicationType
  direction CommunicationDirection @default(OUTBOUND)
  subject   String?
  content   String?                @db.Text
  createdAt DateTime               @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id])
  agent  User   @relation(fields: [agentId], references: [id])

  @@index([clientId])
  @@index([agentId])
  @@index([createdAt])
  @@map("communications")
}

model WebsiteAnalytics {
  id        String   @id @default(cuid())
  pageUrl   String
  pageTitle String?
  visits    Int      @default(0)
  exits     Int      @default(0)
  date      DateTime
  source    String?

  @@index([date])
  @@index([pageUrl])
  @@map("website_analytics")
}

// =====================
// NEW CRM ENUMS
// =====================

enum LeadStage {
  NEW_ENQUIRY
  CONTACTED
  QUALIFIED
  VIEWING_ARRANGED
  VIEWED
  OFFER_MADE
  NEGOTIATING
  WON
  LOST
}

enum DealStage {
  RESERVATION
  DEPOSIT
  CONTRACT
  PAYMENT_PLAN
  TITLE_DEED
  COMPLETED
  CANCELLED
}

enum DealResult {
  PENDING
  WON
  LOST
  CANCELLED
}

enum BudgetRange {
  UNDER_100K
  FROM_100K_TO_250K
  FROM_250K_TO_500K
  FROM_500K_TO_1M
  OVER_1M
}

enum SourceChannel {
  ORGANIC
  PAID_SEARCH
  SOCIAL_MEDIA
  REFERRAL
  DIRECT
  EMAIL_CAMPAIGN
  EMAIL
  WHATSAPP
  SMS
  PARTNER
  EVENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PaymentStatus {
  PENDING
  RECEIVED
  OVERDUE
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CASH
  CREDIT_CARD
  CRYPTO
  CHECK
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  ASSIGN
  STAGE_CHANGE
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_DUE
  LEAD_ASSIGNED
  DEAL_STAGE_CHANGED
  PAYMENT_RECEIVED
  COMMISSION_APPROVED
  SYSTEM_ALERT
  MENTION
  EMAIL_CHANGE_REQUEST
  EMAIL_CHANGED
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  FOLLOW_UP
  SITE_VISIT
  STAGE_CHANGE
  DOCUMENT_UPLOAD
  PAYMENT_RECEIVED
  TASK_COMPLETED
}

// =====================
// NEW CRM MODELS
// =====================

model Lead {
  id               String       @id @default(cuid())
  leadNumber       String       @unique @default(cuid())
  title            String
  description      String?      @db.Text
  stage            LeadStage    @default(NEW_ENQUIRY)
  estimatedValue   Decimal?     @db.Decimal(15, 2)
  currency         Currency     @default(USD)
  budgetRange      BudgetRange?
  source           LeadSource   @default(WEBSITE)
  sourceChannel    SourceChannel?
  sourceDetail     String?
  propertyType     PropertyType?
  preferredLocation String?
  score            Int?         @default(0)
  temperature      String?
  slaDeadline      DateTime?
  lostReason       String?      @db.Text
  convertedDealId  String?      @unique
  clientId         String
  ownerId          String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Extended fields (mirror enquiry management features)
  tags             String[]     @default([])
  called           Boolean      @default(false)
  spoken           Boolean      @default(false)
  segment          String?      @default("Buyer")
  priority         String?      @default("Medium")
  nextCallDate     DateTime?
  snooze           String?      @default("Active")
  interestedPropertyId String?

  // Relations
  client             Client     @relation(fields: [clientId], references: [id])
  owner              User       @relation("LeadOwner", fields: [ownerId], references: [id])
  convertedDeal      Deal?      @relation("LeadToDeal", fields: [convertedDealId], references: [id])
  interestedProperty Property?  @relation("LeadProperty", fields: [interestedPropertyId], references: [id])
  activities         Activity[]
  tasks              Task[]     @relation("LeadTasks")
  notes              LeadNote[]

  @@index([stage])
  @@index([ownerId])
  @@index([clientId])
  @@index([createdAt])
  @@map("leads")
}

model LeadNote {
  id        String   @id @default(cuid())
  leadId    String
  agentId   String
  content   String   @db.Text
  createdAt DateTime @default(now())

  lead  Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent User @relation("LeadNoteAgent", fields: [agentId], references: [id])

  @@index([leadId])
  @@map("lead_notes")
}

model Deal {
  id                String     @id @default(cuid())
  dealNumber        String     @unique @default(cuid())
  title             String
  description       String?    @db.Text
  dealValue         Decimal    @db.Decimal(15, 2)
  currency          Currency   @default(USD)
  stage             DealStage  @default(RESERVATION)
  result            DealResult @default(PENDING)
  probability       Int?       @default(50)
  propertyType      PropertyType?
  propertyName      String?
  unitNumber        String?
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  lostReason        String?    @db.Text
  clientId          String
  ownerId           String
  fromLeadId        String?    @unique
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  client      Client       @relation(fields: [clientId], references: [id])
  owner       User         @relation("DealOwner", fields: [ownerId], references: [id])
  fromLead    Lead?        @relation("LeadToDeal")
  activities  Activity[]
  tasks       Task[]       @relation("DealTasks")
  payments    Payment[]
  commissions Commission[]
  handovers   Handover[]

  @@index([stage])
  @@index([result])
  @@index([ownerId])
  @@index([clientId])
  @@index([createdAt])
  @@map("deals")
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?      @db.Text
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?
  completedAt DateTime?
  assigneeId  String
  createdById String
  leadId      String?
  dealId      String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  assignee  User  @relation("TaskAssignee", fields: [assigneeId], references: [id])
  createdBy User  @relation("TaskCreator", fields: [createdById], references: [id])
  lead      Lead? @relation("LeadTasks", fields: [leadId], references: [id])
  deal      Deal? @relation("DealTasks", fields: [dealId], references: [id])

  @@index([status])
  @@index([priority])
  @@index([assigneeId])
  @@index([dueDate])
  @@index([leadId])
  @@index([dealId])
  @@map("tasks")
}

model Payment {
  id         String        @id @default(cuid())
  amount     Decimal       @db.Decimal(15, 2)
  currency   Currency      @default(USD)
  status     PaymentStatus @default(PENDING)
  method     PaymentMethod?
  reference  String?
  dueDate    DateTime?
  receivedAt DateTime?
  notes      String?       @db.Text
  dealId     String
  clientId   String
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  deal   Deal   @relation(fields: [dealId], references: [id])
  client Client @relation(fields: [clientId], references: [id])

  @@index([status])
  @@index([dealId])
  @@index([clientId])
  @@index([dueDate])
  @@map("payments")
}

model Commission {
  id         String           @id @default(cuid())
  amount     Decimal          @db.Decimal(15, 2)
  currency   Currency         @default(USD)
  percentage Decimal?         @db.Decimal(5, 2)
  status     CommissionStatus @default(PENDING)
  paidAt     DateTime?
  notes      String?          @db.Text
  dealId     String
  agentId    String
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  // Relations
  deal  Deal @relation(fields: [dealId], references: [id])
  agent User @relation(fields: [agentId], references: [id])

  @@index([status])
  @@index([dealId])
  @@index([agentId])
  @@map("commissions")
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String?          @db.Text
  isRead    Boolean          @default(false)
  link      String?
  userId    String
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id         String      @id @default(cuid())
  action     AuditAction
  entityType String
  entityId   String
  changes    Json?
  ipAddress  String?
  userAgent  String?
  userId     String
  createdAt  DateTime    @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  office      Office   @default(HEAD_OFFICE)
  managerId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  manager User         @relation("TeamManager", fields: [managerId], references: [id])
  members TeamMember[]

  @@index([managerId])
  @@map("teams")
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  joinedAt DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model Campaign {
  id             String         @id @default(cuid())
  name           String
  description    String?        @db.Text
  source         LeadSource?
  channel        SourceChannel?
  budget         Decimal?       @db.Decimal(15, 2)
  spent          Decimal?       @db.Decimal(15, 2)
  leadsGenerated Int            @default(0)
  conversions    Int            @default(0)
  startDate      DateTime?
  endDate        DateTime?
  status         CampaignStatus @default(DRAFT)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  steps CampaignStep[]

  @@index([status])
  @@index([createdAt])
  @@map("campaigns")
}

model CampaignStep {
  id         String   @id @default(cuid())
  campaignId String
  stepOrder  Int
  name       String
  type       String
  config     Json?
  delayDays  Int      @default(0)
  createdAt  DateTime @default(now())

  // Relations
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([stepOrder])
  @@map("campaign_steps")
}

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  title       String
  description String?      @db.Text
  leadId      String?
  dealId      String?
  clientId    String?
  enquiryId   String?
  userId      String
  createdAt   DateTime     @default(now())

  // Relations
  lead    Lead?    @relation(fields: [leadId], references: [id])
  deal    Deal?    @relation(fields: [dealId], references: [id])
  client  Client?  @relation(fields: [clientId], references: [id])
  enquiry Enquiry? @relation(fields: [enquiryId], references: [id])
  user    User     @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([dealId])
  @@index([clientId])
  @@index([enquiryId])
  @@index([userId])
  @@index([createdAt])
  @@map("activities")
}

// --- Phase 3: New models ---

enum HandoverStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  bodyHtml  String   @db.Text
  category  String
  variables String[]
  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

model AutomationRule {
  id           String    @id @default(cuid())
  name         String
  triggerEvent String
  conditions   Json
  actions      Json
  isActive     Boolean   @default(true)
  runCount     Int       @default(0)
  lastRunAt    DateTime?
  createdBy    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("automation_rules")
}

model Handover {
  id           String         @id @default(cuid())
  dealId       String
  clientId     String
  status       HandoverStatus @default(PENDING)
  steps        Json
  assignedToId String
  completedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  deal       Deal   @relation(fields: [dealId], references: [id])
  client     Client @relation(fields: [clientId], references: [id])
  assignedTo User   @relation("HandoverAssignee", fields: [assignedToId], references: [id])

  @@index([dealId])
  @@index([clientId])
  @@index([assignedToId])
  @@map("handovers")
}
